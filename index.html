<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Oakberry Shopping Cart</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #fdf8f6;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 30px;
      border-bottom: 1px solid #ddd;
    }
    header img {
      height: 40px;
    }
    nav a {
      margin: 0 10px;
      text-decoration: none;
      color: #3d0c4e;
      font-weight: bold;
    }
    .cart-icon {
      font-size: 18px;
      color: #3d0c4e;
    }
    .product-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 20px;
    }
    .product-card {
      background: white;
      border: 1px solid #eee;
      border-radius: 8px;
      width: 220px;
      margin: 10px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .product-card img {
      max-width: 100px;
      margin-bottom: 10px;
    }
    .product-card h3 {
      font-size: 16px;
      color: #3d0c4e;
      height: 60px;
    }
    .product-card .price {
      font-size: 18px;
      font-weight: bold;
      color: #3d0c4e;
    }
    .product-card .quantity {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px 0;
    }
    .quantity button {
      background-color: #3d0c4e;
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      font-size: 18px;
      cursor: pointer;
    }
    .quantity input {
      width: 40px;
      text-align: center;
      border: 1px solid #ccc;
      margin: 0 5px;
      height: 30px;
    }
    .add-to-cart {
      background-color: #3d0c4e;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      cursor: pointer;
    }
    .product-img {
      width: 100px;
      height: auto;
      display: block;
      margin: 0 auto 10px;
    }
    /* Cart sidebar styles */
    #cart-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 320px;
      height: 100%;
      background: #fff;
      border-left: 1px solid #ccc;
      padding: 20px;
      display: none;
      flex-direction: column;
      z-index: 1000;
      box-sizing: border-box;
    }
    #cart-sidebar h3 {
      margin: 0 0 15px 0;
      color: #3d0c4e;
      font-weight: bold;
      font-size: 22px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    #cart-items {
      list-style: none;
      padding: 0;
      margin: 0 0 15px 0;
      flex-grow: 1;
      overflow-y: auto;
    }
    .cart-item {
      display: grid;
      grid-template-columns: 1fr auto auto;
      grid-template-rows: auto auto;
      grid-gap: 4px 8px;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding: 10px 0;
      font-size: 14px;
      color: #3d0c4e;
    }
    .cart-item-name {
      grid-column: 1 / 2;
      grid-row: 1 / 2;
      font-weight: 600;
    }
    .cart-item-qty {
      grid-column: 1 / 2;
      grid-row: 2 / 3;
      display: flex;
      align-items: center;
    }
    .cart-item-qty button {
      background-color: #3d0c4e;
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      font-size: 18px;
      cursor: pointer;
      line-height: 1;
      border-radius: 3px;
      margin-right: 6px;
      user-select: none;
    }
    .cart-item-qty input {
      width: 40px;
      text-align: center;
      border: 1px solid #ccc;
      height: 28px;
      font-size: 14px;
      border-radius: 3px;
      pointer-events: none;
      background: #f9f9f9;
    }
    .cart-item-price {
      grid-column: 2 / 3;
      grid-row: 1 / 3;
      font-weight: 600;
      text-align: right;
      white-space: nowrap;
    }
    .cart-item-remove {
      grid-column: 3 / 4;
      grid-row: 1 / 3;
      color: red;
      cursor: pointer;
      font-size: 18px;
      user-select: none;
      text-align: center;
      align-self: center;
      padding-left: 10px;
    }
    #cart-sidebar .cart-totals {
      border-top: 1px solid #ddd;
      padding-top: 15px;
      color: #3d0c4e;
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 15px;
    }
    #cart-sidebar .cart-totals div {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
    }
    #cart-sidebar .cart-footer {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    #cart-sidebar button {
      padding: 12px 15px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      flex: 1;
      user-select: none;
    }
    #cart-sidebar button#process-cart {
      background-color: #d32f2f;
      color: white;
      font-weight: bold;
    }
    #cart-sidebar button#close-cart {
      background-color: #3d0c4e;
      color: white;
    }
    /* Login & Registration modal */
    #loginModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
    }
    #loginModal .modal-content {
      background: white;
      border-radius: 8px;
      padding: 25px 30px;
      max-width: 360px;
      width: 100%;
      box-sizing: border-box;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    #loginModal h2 {
      margin-top: 0;
      color: #3d0c4e;
      font-weight: 700;
      font-size: 24px;
      text-align: center;
      margin-bottom: 20px;
    }
    #loginModal form {
      display: flex;
      flex-direction: column;
    }
    #loginModal label {
      font-size: 14px;
      margin-bottom: 4px;
      color: #3d0c4e;
      font-weight: 600;
    }
    #loginModal input {
      padding: 8px 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    #loginModal button {
      background: #3d0c4e;
      color: white;
      border: none;
      padding: 12px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      margin-bottom: 10px;
    }
    #loginModal .toggle-link {
      text-align: center;
      color: #3d0c4e;
      cursor: pointer;
      font-weight: 600;
      user-select: none;
      text-decoration: underline;
      margin-top: 10px;
    }
    #loginModal .error-message {
      color: red;
      font-size: 13px;
      margin-bottom: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="loginModal">
    <div class="modal-content">
      <h2 id="modalTitle">Iniciar sesión</h2>
      <form id="loginForm">
        <div id="loginFields">
          <label for="loginEmail">Correo electrónico</label>
          <input type="email" id="loginEmail" placeholder="Ingrese su correo" required />
          <label for="loginPassword">Contraseña</label>
          <input type="password" id="loginPassword" placeholder="Ingrese su contraseña" required />
        </div>
        <div id="registerFields" style="display:none;">
          <label for="storeName">Nombre de la tienda</label>
          <input type="text" id="storeName" placeholder="Nombre de la tienda" />
          <label for="companyName">Nombre de la sociedad</label>
          <input type="text" id="companyName" placeholder="Nombre de la sociedad" />
          <label for="phone">Celular</label>
          <input type="text" id="phone" placeholder="Celular" />
          <label for="registerEmail">Correo electrónico</label>
          <input type="email" id="registerEmail" placeholder="Correo electrónico" />
        </div>
        <div class="error-message" id="errorMessage" style="display:none;"></div>
        <button type="submit" id="submitButton">Ingresar</button>
      </form>
      <div class="toggle-link" id="toggleMode">¿No tienes cuenta? Regístrate aquí</div>
    </div>
  </div>

  <header>
    <img src="logo-oakberry.png" alt="Oakberry Logo">
    <div class="cart-icon" onclick="toggleCart(true)" style="cursor:pointer;">🛒 <span id="cart-count">0</span></div>
  </header>

  <div class="product-container"></div>

  <script>
    // Authentication and registration logic
    let isRegistering = false;

    const loginModal = document.getElementById('loginModal');
    const modalTitle = document.getElementById('modalTitle');
    const loginForm = document.getElementById('loginForm');
    const loginFields = document.getElementById('loginFields');
    const registerFields = document.getElementById('registerFields');
    const submitButton = document.getElementById('submitButton');
    const toggleMode = document.getElementById('toggleMode');
    const errorMessage = document.getElementById('errorMessage');

    function showLogin() {
      isRegistering = false;
      modalTitle.textContent = 'Iniciar sesión';
      loginFields.style.display = 'block';
      registerFields.style.display = 'none';
      submitButton.textContent = 'Ingresar';
      toggleMode.textContent = '¿No tienes cuenta? Regístrate aquí';
      errorMessage.style.display = 'none';
      loginForm.reset();
    }

    function showRegister() {
      isRegistering = true;
      modalTitle.textContent = 'Registro';
      loginFields.style.display = 'none';
      registerFields.style.display = 'block';
      submitButton.textContent = 'Registrarse';
      toggleMode.textContent = '¿Ya tienes cuenta? Inicia sesión aquí';
      errorMessage.style.display = 'none';
      loginForm.reset();
    }

    toggleMode.addEventListener('click', () => {
      if (isRegistering) {
        showLogin();
      } else {
        showRegister();
      }
    });

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      errorMessage.style.display = 'none';

      if (isRegistering) {
        // Registration validation
        const store = document.getElementById('storeName').value.trim();
        const company = document.getElementById('companyName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const email = document.getElementById('registerEmail').value.trim();

        if (!store || !company || !phone || !email) {
          errorMessage.textContent = 'Por favor, complete todos los campos.';
          errorMessage.style.display = 'block';
          return;
        }
        // Send mailto with registration info
        const body = `Nueva solicitud:\nTienda: ${store}\nSociedad: ${company}\nCelular: ${phone}\nCorreo: ${email}`;
        const mailto = `mailto:gabriel.solera@oaklatam.com?subject=Solicitud%20de%20registro&body=${encodeURIComponent(body)}`;
        window.location.href = mailto;

        // Save logged state and email in localStorage
        localStorage.setItem('logged', 'true');
        localStorage.setItem('userEmail', email);
        loginModal.style.display = 'none';
        loadProducts();
        renderCart();
        updateCartCount();
      } else {
        // Login validation (simple for demo)
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value.trim();

        if (!email || !password) {
          errorMessage.textContent = 'Por favor, ingrese correo y contraseña.';
          errorMessage.style.display = 'block';
          return;
        }
        // For demo, accept any login
        localStorage.setItem('logged', 'true');
        localStorage.setItem('userEmail', email);
        loginModal.style.display = 'none';
        loadProducts();
        renderCart();
        updateCartCount();
      }
    });

    if (!localStorage.getItem('logged')) {
      loginModal.style.display = 'flex';
    } else {
      loginModal.style.display = 'none';
    }

    // Cart logic
    function saveCart() {
      localStorage.setItem('cart', JSON.stringify(cart));
    }

    function loadCart() {
      const stored = localStorage.getItem('cart');
      return stored ? JSON.parse(stored) : [];
    }

    let cart = loadCart();

    function updateCartCount() {
      // Also update the cart total in the cart icon if desired in the future
      const count = cart.reduce((acc, item) => acc + (parseInt(item.qty) || 0), 0);
      document.getElementById('cart-count').textContent = count;
    }

    updateCartCount();

    const sheetID = "1okncHg_P3rzFLxqfs_lZvwiAwI5_GuJn";
    const gid = "1049247424";
    const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&gid=${gid}`;

    function loadProducts() {
      fetch(sheetURL)
        .then(res => res.text())
        .then(text => {
          // Quitar el texto extra para quedarnos con JSON puro
          const json = JSON.parse(text.substring(47).slice(0, -2));
          const rows = json.table.rows;
          const container = document.querySelector('.product-container');
          container.innerHTML = "";

          rows.forEach(row => {
            const nombre = row.c[0]?.v || ""; // Item Name
            const sku = row.c[1]?.v || "";    // SKU
            const precio = row.c[2]?.v || ""; // Selling Price
            const status = row.c[3]?.v || ""; // Status
            const unidad = row.c[4]?.v || ""; // Unit

            if (status.toLowerCase() !== "active") return;

            const card = document.createElement("div");
            card.className = "product-card";

            const imageName = `${sku.toUpperCase()}.png`;
            const imagePath = imageName;

            card.innerHTML = `
              <img src="${imagePath}" alt="${nombre}" class="product-img" />
              <h3>${nombre}</h3>
              <p><strong>SKU:</strong> ${sku}</p>
              <p class="price">₡${Math.round(precio)}</p>
              <p><strong>Unidad:</strong> ${unidad}</p>
              <div class="quantity">
                <button class="minus">−</button>
                <input type="text" value="1" readonly>
                <button class="plus">+</button>
              </div>
              <button class="add-to-cart">Agregar al carrito</button>
            `;
            container.appendChild(card);
          });

          attachEvents();
        })
        .catch(err => {
          console.error("Error al cargar los productos:", err);
          document.querySelector('.product-container').innerHTML = 
            "<p>No se pudieron cargar los productos.</p>";
        });
    }

    if(localStorage.getItem('logged')) {
      loadProducts();
    }

    function toggleCart(show) {
      const cartSidebar = document.getElementById("cart-sidebar");
      cartSidebar.style.display = show ? "flex" : "none";
      if(show) {
        renderCart();
      }
    }

    function formatCurrencyCR(amount) {
      // Always show as ₡ with thousand separators, no decimals
      return '₡' + Number(amount).toLocaleString('es-CR', { maximumFractionDigits: 0 });
    }

    function renderCart() {
      const cartList = document.getElementById("cart-items");
      cartList.innerHTML = "";
      let subtotal = 0;
      cart.forEach((item, i) => {
        // Validate product data
        if (
          typeof item.price === 'undefined' ||
          typeof item.qty === 'undefined' ||
          isNaN(parseFloat(item.price)) ||
          isNaN(parseInt(item.qty))
        ) return;
        const unitPrice = parseFloat(item.price);
        const quantity = parseInt(item.qty);
        const totalItem = unitPrice * quantity;
        subtotal += totalItem;

        // Layout: image left, details center, subtotal right, controls below details
        const li = document.createElement("li");
        li.className = 'cart-item';
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.gap = '10px';
        li.style.padding = '12px 0';
        li.style.borderBottom = '1px solid #eee';
        // Product image
        const imgDiv = document.createElement('div');
        imgDiv.style.flex = '0 0 60px';
        imgDiv.style.display = 'flex';
        imgDiv.style.alignItems = 'center';
        imgDiv.style.justifyContent = 'center';
        const img = document.createElement('img');
        img.src = (item.sku ? item.sku.toUpperCase() : '') + '.png';
        img.alt = item.name || '';
        img.style.width = '54px';
        img.style.height = '54px';
        img.style.objectFit = 'contain';
        img.style.borderRadius = '7px';
        imgDiv.appendChild(img);
        // Details (name, SKU, qty controls)
        const detailsDiv = document.createElement('div');
        detailsDiv.style.flex = '1 1 auto';
        detailsDiv.style.display = 'flex';
        detailsDiv.style.flexDirection = 'column';
        // Name
        const nameDiv = document.createElement('div');
        nameDiv.textContent = item.name || '';
        nameDiv.style.fontWeight = 'bold';
        nameDiv.style.fontSize = '15px';
        nameDiv.style.color = '#3d0c4e';
        nameDiv.style.marginBottom = '3px';
        detailsDiv.appendChild(nameDiv);
        // SKU and quantity
        const infoDiv = document.createElement('div');
        infoDiv.style.fontSize = '12px';
        infoDiv.style.color = '#333';
        infoDiv.textContent = (item.sku ? 'SKU: ' + item.sku + ' | ' : '') + 'Cantidad: ' + quantity;
        detailsDiv.appendChild(infoDiv);
        // Quantity controls
        const qtyDiv = document.createElement('div');
        qtyDiv.style.marginTop = '6px';
        qtyDiv.style.display = 'flex';
        qtyDiv.style.alignItems = 'center';
        // Minus button
        const minusBtn = document.createElement('button');
        minusBtn.textContent = '−';
        minusBtn.style.backgroundColor = '#3d0c4e';
        minusBtn.style.color = 'white';
        minusBtn.style.border = 'none';
        minusBtn.style.width = '28px';
        minusBtn.style.height = '28px';
        minusBtn.style.fontSize = '18px';
        minusBtn.style.cursor = 'pointer';
        minusBtn.style.borderRadius = '3px';
        minusBtn.onclick = function() { changeQuantity(i, -1); };
        qtyDiv.appendChild(minusBtn);
        // Qty input
        const qtyInput = document.createElement('input');
        qtyInput.type = 'text';
        qtyInput.value = quantity;
        qtyInput.readOnly = true;
        qtyInput.style.width = '40px';
        qtyInput.style.textAlign = 'center';
        qtyInput.style.border = '1px solid #ccc';
        qtyInput.style.height = '28px';
        qtyInput.style.fontSize = '14px';
        qtyInput.style.margin = '0 4px';
        qtyInput.style.background = '#f9f9f9';
        qtyInput.style.borderRadius = '3px';
        qtyDiv.appendChild(qtyInput);
        // Plus button
        const plusBtn = document.createElement('button');
        plusBtn.textContent = '+';
        plusBtn.style.backgroundColor = '#3d0c4e';
        plusBtn.style.color = 'white';
        plusBtn.style.border = 'none';
        plusBtn.style.width = '28px';
        plusBtn.style.height = '28px';
        plusBtn.style.fontSize = '18px';
        plusBtn.style.cursor = 'pointer';
        plusBtn.style.borderRadius = '3px';
        plusBtn.onclick = function() { changeQuantity(i, 1); };
        qtyDiv.appendChild(plusBtn);
        detailsDiv.appendChild(qtyDiv);
        // Subtotal right
        const priceDiv = document.createElement('div');
        priceDiv.textContent = formatCurrencyCR(totalItem);
        priceDiv.style.fontWeight = 'bold';
        priceDiv.style.fontSize = '16px';
        priceDiv.style.color = '#3d0c4e';
        priceDiv.style.marginLeft = '10px';
        priceDiv.style.whiteSpace = 'nowrap';
        // Remove button
        const removeDiv = document.createElement('div');
        removeDiv.title = 'Eliminar';
        removeDiv.textContent = '🗑️';
        removeDiv.style.color = 'red';
        removeDiv.style.cursor = 'pointer';
        removeDiv.style.fontSize = '18px';
        removeDiv.style.marginLeft = '12px';
        removeDiv.onclick = function() { removeFromCart(i); };
        // Layout: [img][details][price][remove]
        li.appendChild(imgDiv);
        li.appendChild(detailsDiv);
        li.appendChild(priceDiv);
        li.appendChild(removeDiv);
        cartList.appendChild(li);
      });
      const iva = subtotal * 0.13;
      const total = subtotal + iva;
      document.getElementById("subtotal").textContent = formatCurrencyCR(subtotal);
      document.getElementById("iva").textContent = formatCurrencyCR(iva);
      document.getElementById("total").textContent = formatCurrencyCR(total);
      document.getElementById("cart-count").textContent = cart.reduce((acc, item) => acc + (parseInt(item.qty) || 0), 0);
      // Update cart icon total in header if needed (optional)
    }

    function removeFromCart(index) {
      if (index < 0 || index >= cart.length) return;
      cart.splice(index, 1);
      saveCart();
      renderCart();
      updateCartCount();
    }

    function changeQuantity(index, delta) {
      if (index < 0 || index >= cart.length) return;
      let newQty = cart[index].qty + delta;
      if (newQty < 1) newQty = 1;
      cart[index].qty = newQty;
      saveCart();
      renderCart();
      updateCartCount();
    }

    function attachEvents() {
      document.querySelectorAll('.add-to-cart').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const card = e.target.closest('.product-card');
          const name = card.querySelector('h3').textContent;
          const sku = card.querySelector('p').textContent.split("SKU: ")[1];
          const priceText = card.querySelector('.price').textContent.replace(/[₡$]/g, "");
          const price = parseFloat(priceText);
          const qty = parseInt(card.querySelector('input').value);

          if (isNaN(price) || isNaN(qty)) return;

          // Check if product already in cart
          const index = cart.findIndex(item => item.sku === sku);
          if(index !== -1) {
            cart[index].qty = (parseInt(cart[index].qty) || 0) + qty;
          } else {
            cart.push({ name, sku, price, qty });
          }
          saveCart();
          renderCart();
          updateCartCount();
          toggleCart(true);
        });
      });

      document.querySelectorAll('.product-card').forEach(card => {
        const minus = card.querySelector('.minus');
        const plus = card.querySelector('.plus');
        const input = card.querySelector('input');

        minus.addEventListener('click', () => {
          let v = parseInt(input.value);
          if (v > 1) input.value = v - 1;
        });
        plus.addEventListener('click', () => {
          let v = parseInt(input.value);
          input.value = v + 1;
        });
      });
    }

    // On load
    window.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem('logged')) {
        renderCart();
        updateCartCount();
      }
    });

    // Process purchase button click
    document.addEventListener('DOMContentLoaded', () => {
      const processBtn = document.getElementById('process-cart');
      processBtn.addEventListener('click', () => {
        if(cart.length === 0) {
          alert("El carrito está vacío.");
          return;
        }
        alert("Gracias por su compra. Procesando...");
        cart = [];
        saveCart();
        renderCart();
        updateCartCount();
        toggleCart(false);
      });
    });
  </script>

  <div id="cart-sidebar" style="flex-direction: column;">
    <h3>Carrito</h3>
    <ul id="cart-items" style="padding: 0; margin: 0;"></ul>
    <div class="cart-totals">
      <div><span>Subtotal:</span><span id="subtotal">₡0</span></div>
      <div><span>IVA (13%):</span><span id="iva">₡0</span></div>
      <div><strong>Total:</strong><strong id="total">₡0</strong></div>
    </div>
    <div class="cart-footer" style="justify-content: flex-end;">
      <button id="close-cart" onclick="toggleCart(false)">Cerrar</button>
      <button id="process-cart" style="background: #d32f2f; color: #fff; font-weight: bold; margin-left: 10px; min-width: 160px;">Procesar compra</button>
    </div>
  </div>
</body>
</html>
