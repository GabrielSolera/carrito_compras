<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Oakberry Shopping Cart</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #fdf8f6;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 30px;
      border-bottom: 1px solid #ddd;
    }
    header img {
      height: 40px;
    }
    nav a {
      margin: 0 10px;
      text-decoration: none;
      color: #3d0c4e;
      font-weight: bold;
    }
    .cart-icon {
      font-size: 18px;
      color: #3d0c4e;
    }
    .product-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 20px;
    }
    .product-card {
      background: white;
      border: 1px solid #eee;
      border-radius: 8px;
      width: 220px;
      margin: 10px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .product-card img {
      max-width: 100px;
      margin-bottom: 10px;
    }
    .product-card h3 {
      font-size: 16px;
      color: #3d0c4e;
      height: 60px;
    }
    .product-card .price {
      font-size: 18px;
      font-weight: bold;
      color: #3d0c4e;
    }
    .product-card .quantity {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px 0;
    }
    .quantity button {
      background-color: #3d0c4e;
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      font-size: 18px;
      cursor: pointer;
    }
    .quantity input {
      width: 40px;
      text-align: center;
      border: 1px solid #ccc;
      margin: 0 5px;
      height: 30px;
    }
    .add-to-cart {
      background-color: #3d0c4e;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      cursor: pointer;
    }
    .product-img {
      width: 100px;
      height: auto;
      display: block;
      margin: 0 auto 10px;
    }
    /* Cart sidebar styles */
    #cart-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 320px;
      height: 100%;
      background: #fff;
      border-left: 1px solid #ccc;
      padding: 20px;
      display: none;
      flex-direction: column;
      z-index: 1000;
      box-sizing: border-box;
    }
    #cart-sidebar h3 {
      margin: 0 0 15px 0;
      color: #3d0c4e;
      font-weight: bold;
      font-size: 22px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    #cart-items {
      list-style: none;
      padding: 0;
      margin: 0 0 15px 0;
      flex-grow: 1;
      overflow-y: auto;
    }
    .cart-item {
      display: grid;
      grid-template-columns: 1fr auto auto;
      grid-template-rows: auto auto;
      grid-gap: 4px 8px;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding: 10px 0;
      font-size: 14px;
      color: #3d0c4e;
    }
    .cart-item-name {
      grid-column: 1 / 2;
      grid-row: 1 / 2;
      font-weight: 600;
    }
    .cart-item-qty {
      grid-column: 1 / 2;
      grid-row: 2 / 3;
      display: flex;
      align-items: center;
    }
    .cart-item-qty button {
      background-color: #3d0c4e;
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      font-size: 18px;
      cursor: pointer;
      line-height: 1;
      border-radius: 3px;
      margin-right: 6px;
      user-select: none;
    }
    .cart-item-qty input {
      width: 40px;
      text-align: center;
      border: 1px solid #ccc;
      height: 28px;
      font-size: 14px;
      border-radius: 3px;
      pointer-events: none;
      background: #f9f9f9;
    }
    .cart-item-price {
      grid-column: 2 / 3;
      grid-row: 1 / 3;
      font-weight: 600;
      text-align: right;
      white-space: nowrap;
    }
    .cart-item-remove {
      grid-column: 3 / 4;
      grid-row: 1 / 3;
      color: red;
      cursor: pointer;
      font-size: 18px;
      user-select: none;
      text-align: center;
      align-self: center;
      padding-left: 10px;
    }
    #cart-sidebar .cart-totals {
      border-top: 1px solid #ddd;
      padding-top: 15px;
      color: #3d0c4e;
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 15px;
    }
    #cart-sidebar .cart-totals div {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
    }
    #cart-sidebar .cart-footer {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    #cart-sidebar button {
      padding: 12px 15px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      flex: 1;
      user-select: none;
    }
    #cart-sidebar button#process-cart {
      background-color: #d32f2f;
      color: white;
      font-weight: bold;
    }
    #cart-sidebar button#close-cart {
      background-color: #3d0c4e;
      color: white;
    }
    /* Login & Registration modal */
    #loginModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
    }
    #loginModal .modal-content {
      background: white;
      border-radius: 8px;
      padding: 25px 30px;
      max-width: 360px;
      width: 100%;
      box-sizing: border-box;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    #loginModal h2 {
      margin-top: 0;
      color: #3d0c4e;
      font-weight: 700;
      font-size: 24px;
      text-align: center;
      margin-bottom: 20px;
    }
    #loginModal form {
      display: flex;
      flex-direction: column;
    }
    #loginModal label {
      font-size: 14px;
      margin-bottom: 4px;
      color: #3d0c4e;
      font-weight: 600;
    }
    #loginModal input {
      padding: 8px 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    #loginModal button {
      background: #3d0c4e;
      color: white;
      border: none;
      padding: 12px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      margin-bottom: 10px;
    }
    #loginModal .toggle-link {
      text-align: center;
      color: #3d0c4e;
      cursor: pointer;
      font-weight: 600;
      user-select: none;
      text-decoration: underline;
      margin-top: 10px;
    }
    #loginModal .error-message {
      color: red;
      font-size: 13px;
      margin-bottom: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="loginModal">
    <div class="modal-content">
      <h2 id="modalTitle">Iniciar sesión</h2>
      <form id="loginForm">
        <div id="loginFields">
          <label for="loginEmail">Correo electrónico</label>
          <input type="email" id="loginEmail" placeholder="Ingrese su correo" required />
          <label for="loginPassword">Contraseña</label>
          <input type="password" id="loginPassword" placeholder="Ingrese su contraseña" required />
        </div>
        <div id="registerFields" style="display:none;">
          <label for="storeName">Nombre de la tienda</label>
          <input type="text" id="storeName" placeholder="Nombre de la tienda" />
          <label for="companyName">Nombre de la sociedad</label>
          <input type="text" id="companyName" placeholder="Nombre de la sociedad" />
          <label for="phone">Celular</label>
          <input type="text" id="phone" placeholder="Celular" />
          <label for="registerEmail">Correo electrónico</label>
          <input type="email" id="registerEmail" placeholder="Correo electrónico" />
        </div>
        <div class="error-message" id="errorMessage" style="display:none;"></div>
        <button type="submit" id="submitButton">Ingresar</button>
      </form>
      <div class="toggle-link" id="toggleMode">¿No tienes cuenta? Regístrate aquí</div>
    </div>
  </div>

  <header>
    <img src="logo-oakberry.png" alt="Oakberry Logo">
    <div style="display: flex; align-items: center; gap: 16px;">
      <!-- Store selection dropdown and delivery address -->
      <div style="padding: 1em;">
        <label for="storeSelector">Tienda:</label>
        <select id="storeSelector" onchange="handleStoreChange(this.value)">
          <option value="City Mall">City Mall</option>
          <option value="Avenida Escazú">Avenida Escazú</option>
          <option value="Guachipelin">Guachipelin</option>
          <option value="Oak Truck">Oak Truck</option>
          <option value="Santa Ana Town Center">Santa Ana Town Center</option>
        </select>
        <button id="clearCartBtn" class="clear-cart" style="margin-left: 8px;">🗑 Limpiar carrito</button>
        <!-- Dynamic delivery address shown below dropdown -->
        <div id="selected-store-address" style="margin-top: 0.5em; color: #3d0c4e; font-size: 15px;">
          <span id="selected-store-address-value"></span>
        </div>
      </div>
      <div class="cart-icon" onclick="toggleCart(true)" style="cursor:pointer;">🛒 <span id="cart-count">0</span></div>
    </div>
  <!-- FontAwesome CDN for store icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  </header>

  <div class="product-container"></div>

  <!-- Store selection modal -->
  <div id="store-modal" style="display:none; position:fixed; z-index:1100; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); align-items:center; justify-content:center;">
    <div style="background: #fff; border-radius: 10px; padding: 25px 28px; min-width: 300px; box-shadow: 0 2px 16px rgba(0,0,0,0.18); position:relative;">
      <div style="font-size: 20px; font-weight: bold; color: #3d0c4e; margin-bottom: 18px; display: flex; align-items: center; gap: 6px;">
        🏬 Selecciona tu tienda
      </div>
      <ul id="store-list" style="list-style:none; padding:0; margin:0;">
        <!-- Store options injected by JS -->
      </ul>
      <button id="close-store-modal" style="position:absolute; top:10px; right:13px; background:none; border:none; font-size:19px; color:#999; cursor:pointer;">×</button>
    </div>
  </div>

  <!-- Delivery address moved below the dropdown above -->
  <!-- Script para lógica de selección de tiendas -->
  <script>
    // Datos de tiendas
    const STORES_DATA = [
      {
        name: "City Mall",
        address: "Centro Comercial City Mall Alajuela, Nivel 2"
      },
      {
        name: "Avenida Escazú",
        address: "Avenida Escazú, Local 102 Edificio 202"
      },
      {
        name: "Guachipelín",
        address: "Centro Comercial calle real en Guachipelín de Escazú, local 2"
      },
      {
        name: "Oak Truck",
        address: "Centro comercial Aleste, Curridabat"
      },
      {
        name: "Santa Ana Town Center",
        address: "Plaza Town Center, Calle Margarita Norte, Ave 3., Santa Ana"
      }
    ];

    // Obtener tienda seleccionada de localStorage
    function getSelectedStore_v2() {
      try {
        const raw = localStorage.getItem('selectedStore');
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !obj.name) return null;
        return obj;
      } catch(e) { return null; }
    }
    // Establecer tienda seleccionada en localStorage
    function setSelectedStore_v2(storeObj) {
      if (!storeObj || !storeObj.name) return;
      localStorage.setItem('selectedStore', JSON.stringify(storeObj));
    }
    // Actualizar etiquetas de tienda y dirección
    function updateStoreDisplay_v2() {
      const store = getSelectedStore_v2();
      const label = document.getElementById('selected-store-label');
      const addr = document.getElementById('delivery-address-value');
      if (store) {
        label.textContent = store.name;
        addr.textContent = store.address;
      } else {
        label.textContent = "Seleccionar tienda";
        addr.textContent = "No seleccionada";
      }
    }
    // Mostrar/ocultar modal de tiendas
    function showStoreModal_v2(show) {
      document.getElementById('store-modal').style.display = show ? 'flex' : 'none';
    }
    // Renderizar lista de tiendas en el modal
    function renderStoreList_v2() {
      const ul = document.getElementById('store-list');
      ul.innerHTML = '';
      const selected = getSelectedStore_v2();
      STORES_DATA.forEach(store => {
        const li = document.createElement('li');
        li.style.marginBottom = '10px';
        li.style.padding = '0';
        // Botón con nombre y dirección
        const btn = document.createElement('button');
        btn.style.width = '100%';
        btn.style.background = selected && selected.name === store.name ? '#3d0c4e' : '#f4e6fa';
        btn.style.color = selected && selected.name === store.name ? '#fff' : '#3d0c4e';
        btn.style.border = '1px solid #3d0c4e';
        btn.style.borderRadius = '5px';
        btn.style.fontSize = '15px';
        btn.style.fontWeight = '600';
        btn.style.padding = '12px 10px';
        btn.style.cursor = 'pointer';
        btn.style.transition = 'background 0.15s';
        btn.style.display = 'flex';
        btn.style.flexDirection = 'column';
        btn.style.alignItems = 'flex-start';
        // Nombre
        const nameSpan = document.createElement('span');
        nameSpan.textContent = store.name;
        nameSpan.style.fontWeight = 'bold';
        // Dirección
        const addrSpan = document.createElement('span');
        addrSpan.textContent = store.address;
        addrSpan.style.fontWeight = 'normal';
        addrSpan.style.fontSize = '13px';
        addrSpan.style.marginTop = '2px';
        addrSpan.style.color = '#653a7a';
        btn.appendChild(nameSpan);
        btn.appendChild(addrSpan);
        btn.addEventListener('click', () => {
          setSelectedStore_v2(store);
          updateStoreDisplay_v2();
          showStoreModal_v2(false);
        });
        li.appendChild(btn);
        ul.appendChild(li);
      });
    }
    // Eliminar textos repetidos o innecesarios sobre el listado si existieran
    document.addEventListener('DOMContentLoaded', () => {
      // El modal ya tiene solo un título, no hay textos repetidos por defecto.
      // Si hubiera, aquí podríamos removerlos.
      // Configuración de eventos:
      document.getElementById('store-select-btn').addEventListener('click', () => {
        renderStoreList_v2();
        showStoreModal_v2(true);
      });
      document.getElementById('close-store-modal').addEventListener('click', () => {
        showStoreModal_v2(false);
      });
      document.getElementById('store-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('store-modal')) showStoreModal_v2(false);
      });
      // Inicializar visualización
      updateStoreDisplay_v2();
      // Si no hay tienda seleccionada, pedir selección
      if (!getSelectedStore_v2()) {
        setTimeout(() => {
          renderStoreList_v2();
          showStoreModal_v2(true);
        }, 400);
      }
    });
    // Actualizar visualización al cargar
    window.addEventListener('DOMContentLoaded', updateStoreDisplay_v2);
  </script>

  <script>
    // Store data
    const STORES = [
      {
        name: "City Mall",
        address: "Centro Comercial City Mall Alajuela, Nivel 2"
      },
      {
        name: "Avenida Escazú",
        address: "Avenida Escazú, Local 102 Edificio 202"
      },
      {
        name: "Guachipelín",
        address: "Centro Comercial calle real en Guachipelín de Escazú, local 2"
      },
      {
        name: "Oak Truck",
        address: "Centro comercial Aleste, Curridabat"
      },
      {
        name: "Santa Ana Town Center",
        address: "Plaza Town Center, Calle Margarita Norte, Ave 3., Santa Ana"
      }
    ];
    // Store selection logic
    function getSelectedStore() {
      try {
        const raw = localStorage.getItem('selectedStore');
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !obj.name) return null;
        return obj;
      } catch(e) { return null; }
    }
    function setSelectedStore(storeObj) {
      if (!storeObj || !storeObj.name) return;
      localStorage.setItem('selectedStore', JSON.stringify(storeObj));
    }
    function updateStoreDisplay() {
      const store = getSelectedStore();
      const label = document.getElementById('selected-store-label');
      const addr = document.getElementById('delivery-address-value');
      if (store) {
        label.textContent = store.name;
        addr.textContent = store.address;
      } else {
        label.textContent = "Seleccionar tienda";
        addr.textContent = "No seleccionada";
      }
    }
    function showStoreModal(show) {
      document.getElementById('store-modal').style.display = show ? 'flex' : 'none';
    }
    // function renderStoreList() {
    //   const ul = document.getElementById('store-list');
    //   ul.innerHTML = '';
    //   const selected = getSelectedStore();
    //   STORES.forEach(store => {
    //     const li = document.createElement('li');
    //     li.style.marginBottom = '10px';
    //     li.style.padding = '0';
    //     const btn = document.createElement('button');
    //     btn.textContent = store.name;
    //     btn.style.width = '100%';
    //     btn.style.background = selected && selected.name === store.name ? '#3d0c4e' : '#f4e6fa';
    //     btn.style.color = selected && selected.name === store.name ? '#fff' : '#3d0c4e';
    //     btn.style.border = '1px solid #3d0c4e';
    //     btn.style.borderRadius = '5px';
    //     btn.style.fontSize = '15px';
    //     btn.style.fontWeight = '600';
    //     btn.style.padding = '12px 10px';
    //     btn.style.cursor = 'pointer';
    //     btn.style.transition = 'background 0.15s';
    //     btn.addEventListener('click', () => {
    //       setSelectedStore(store);
    //       updateStoreDisplay();
    //       showStoreModal(false);
    //     });
    //     li.appendChild(btn);
    //     ul.appendChild(li);
    //   });
    // }
    // Setup store selection UI
    document.addEventListener('DOMContentLoaded', () => {
      // Delivery address bar: move below header
      const header = document.querySelector('header');
      const addrBar = document.getElementById('delivery-address-bar');
      if (header && addrBar && header.nextSibling !== addrBar) {
        header.parentNode.insertBefore(addrBar, header.nextSibling);
      }
      updateStoreDisplay();
      // Open modal on button click
      // document.getElementById('store-select-btn').addEventListener('click', () => {
      //   renderStoreList();
      //   showStoreModal(true);
      // });
      // // Close modal
      // document.getElementById('close-store-modal').addEventListener('click', () => {
      //   showStoreModal(false);
      // });
      // // Hide modal on outside click
      // document.getElementById('store-modal').addEventListener('click', (e) => {
      //   if (e.target === document.getElementById('store-modal')) showStoreModal(false);
      // });
      // // On load, if no store selected, prompt user to select store
      // if (!getSelectedStore()) {
      //   setTimeout(() => {
      //     renderStoreList();
      //     showStoreModal(true);
      //   }, 400);
      // }
    });
    // On page load, always update store display (in case of refresh)
    // updateStoreDisplay();
    // Authentication and registration logic
    let isRegistering = false;

    const loginModal = document.getElementById('loginModal');
    const modalTitle = document.getElementById('modalTitle');
    const loginForm = document.getElementById('loginForm');
    const loginFields = document.getElementById('loginFields');
    const registerFields = document.getElementById('registerFields');
    const submitButton = document.getElementById('submitButton');
    const toggleMode = document.getElementById('toggleMode');
    const errorMessage = document.getElementById('errorMessage');

    function showLogin() {
      isRegistering = false;
      modalTitle.textContent = 'Iniciar sesión';
      loginFields.style.display = 'block';
      registerFields.style.display = 'none';
      submitButton.textContent = 'Ingresar';
      toggleMode.textContent = '¿No tienes cuenta? Regístrate aquí';
      errorMessage.style.display = 'none';
      loginForm.reset();
    }

    function showRegister() {
      isRegistering = true;
      modalTitle.textContent = 'Registro';
      loginFields.style.display = 'none';
      registerFields.style.display = 'block';
      submitButton.textContent = 'Registrarse';
      toggleMode.textContent = '¿Ya tienes cuenta? Inicia sesión aquí';
      errorMessage.style.display = 'none';
      loginForm.reset();
    }

    toggleMode.addEventListener('click', () => {
      if (isRegistering) {
        showLogin();
      } else {
        showRegister();
      }
    });

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      errorMessage.style.display = 'none';

      if (isRegistering) {
        // Registration validation
        const store = document.getElementById('storeName').value.trim();
        const company = document.getElementById('companyName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const email = document.getElementById('registerEmail').value.trim();

        if (!store || !company || !phone || !email) {
          errorMessage.textContent = 'Por favor, complete todos los campos.';
          errorMessage.style.display = 'block';
          return;
        }
        // Send mailto with registration info
        const body = `Nueva solicitud:\nTienda: ${store}\nSociedad: ${company}\nCelular: ${phone}\nCorreo: ${email}`;
        const mailto = `mailto:gabriel.solera@oaklatam.com?subject=Solicitud%20de%20registro&body=${encodeURIComponent(body)}`;
        window.location.href = mailto;

        // Save logged state and email in localStorage
        localStorage.setItem('logged', 'true');
        localStorage.setItem('userEmail', email);
        loginModal.style.display = 'none';
        loadProducts();
        renderCart();
        updateCartCount();
      } else {
        // Login validation (simple for demo)
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value.trim();

        if (!email || !password) {
          errorMessage.textContent = 'Por favor, ingrese correo y contraseña.';
          errorMessage.style.display = 'block';
          return;
        }
        // For demo, accept any login
        localStorage.setItem('logged', 'true');
        localStorage.setItem('userEmail', email);
        loginModal.style.display = 'none';
        loadProducts();
        renderCart();
        updateCartCount();
      }
    });

    if (!localStorage.getItem('logged')) {
      loginModal.style.display = 'flex';
    } else {
      loginModal.style.display = 'none';
    }

    // Cart logic
    function saveCart() {
      localStorage.setItem('cart', JSON.stringify(cart));
    }

    function loadCart() {
      const stored = localStorage.getItem('cart');
      return stored ? JSON.parse(stored) : [];
    }

    let cart = loadCart();

    function updateCartCount() {
      // Also update the cart total in the cart icon if desired in the future
      const count = cart.reduce((acc, item) => acc + (parseInt(item.qty) || 0), 0);
      document.getElementById('cart-count').textContent = count;
    }

    updateCartCount();

    const sheetID = "1okncHg_P3rzFLxqfs_lZvwiAwI5_GuJn";
    const gid = "1049247424";
    const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&gid=${gid}`;

    function loadProducts() {
      fetch(sheetURL)
        .then(res => res.text())
        .then(text => {
          // Quitar el texto extra para quedarnos con JSON puro
          const json = JSON.parse(text.substring(47).slice(0, -2));
          const rows = json.table.rows;
          const container = document.querySelector('.product-container');
          container.innerHTML = "";

          rows.forEach(row => {
            const nombre = row.c[0]?.v || ""; // Item Name
            const sku = row.c[1]?.v || "";    // SKU
            const precio = row.c[2]?.v || ""; // Selling Price
            const status = row.c[3]?.v || ""; // Status
            const unidad = row.c[4]?.v || ""; // Unit

            if (status.toLowerCase() !== "active") return;

            const card = document.createElement("div");
            card.className = "product-card";

            const imageName = `${sku.toUpperCase()}.png`;
            const imagePath = imageName;

            card.innerHTML = `
              <img src="${imagePath}" alt="${nombre}" class="product-img" />
              <h3>${nombre}</h3>
              <p><strong>SKU:</strong> ${sku}</p>
              <p class="price">₡${Math.round(precio)}</p>
              <p><strong>Unidad:</strong> ${unidad}</p>
              <div class="quantity">
                <button class="minus">−</button>
                <input type="text" value="1" readonly>
                <button class="plus">+</button>
              </div>
              <button class="add-to-cart">Agregar al carrito</button>
            `;
            container.appendChild(card);
          });

          attachEvents();
        })
        .catch(err => {
          console.error("Error al cargar los productos:", err);
          document.querySelector('.product-container').innerHTML = 
            "<p>No se pudieron cargar los productos.</p>";
        });
    }

    if(localStorage.getItem('logged')) {
      loadProducts();
    }

    function toggleCart(show) {
      const cartSidebar = document.getElementById("cart-sidebar");
      cartSidebar.style.display = show ? "flex" : "none";
      if(show) {
        renderCart();
      }
    }

    function formatCurrencyCR(amount) {
      // Always show as ₡ with thousand separators, no decimals
      return '₡' + Number(amount).toLocaleString('es-CR', { maximumFractionDigits: 0 });
    }

    function renderCart() {
      const cartList = document.getElementById("cart-items");
      cartList.innerHTML = "";
      let subtotal = 0;
      cart.forEach((item, i) => {
        // Validate product data
        if (
          typeof item.price === 'undefined' ||
          typeof item.qty === 'undefined' ||
          isNaN(parseFloat(item.price)) ||
          isNaN(parseInt(item.qty))
        ) return;
        const unitPrice = parseFloat(item.price);
        const quantity = parseInt(item.qty);
        const totalItem = unitPrice * quantity;
        subtotal += totalItem;

        // Layout: image left, details center, subtotal right, controls below details
        const li = document.createElement("li");
        li.className = 'cart-item';
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.gap = '10px';
        li.style.padding = '12px 0';
        li.style.borderBottom = '1px solid #eee';
        // Product image
        const imgDiv = document.createElement('div');
        imgDiv.style.flex = '0 0 60px';
        imgDiv.style.display = 'flex';
        imgDiv.style.alignItems = 'center';
        imgDiv.style.justifyContent = 'center';
        const img = document.createElement('img');
        img.src = (item.sku ? item.sku.toUpperCase() : '') + '.png';
        img.alt = item.name || '';
        img.style.width = '54px';
        img.style.height = '54px';
        img.style.objectFit = 'contain';
        img.style.borderRadius = '7px';
        imgDiv.appendChild(img);
        // Details (name, SKU, qty controls)
        const detailsDiv = document.createElement('div');
        detailsDiv.style.flex = '1 1 auto';
        detailsDiv.style.display = 'flex';
        detailsDiv.style.flexDirection = 'column';
        // Name
        const nameDiv = document.createElement('div');
        nameDiv.textContent = item.name || '';
        nameDiv.style.fontWeight = 'bold';
        nameDiv.style.fontSize = '15px';
        nameDiv.style.color = '#3d0c4e';
        nameDiv.style.marginBottom = '3px';
        detailsDiv.appendChild(nameDiv);
        // SKU and quantity
        const infoDiv = document.createElement('div');
        infoDiv.style.fontSize = '12px';
        infoDiv.style.color = '#333';
        infoDiv.textContent = (item.sku ? 'SKU: ' + item.sku + ' | ' : '') + 'Cantidad: ' + quantity;
        detailsDiv.appendChild(infoDiv);
        // Quantity controls
        const qtyDiv = document.createElement('div');
        qtyDiv.style.marginTop = '6px';
        qtyDiv.style.display = 'flex';
        qtyDiv.style.alignItems = 'center';
        // Minus button
        const minusBtn = document.createElement('button');
        minusBtn.textContent = '−';
        minusBtn.style.backgroundColor = '#3d0c4e';
        minusBtn.style.color = 'white';
        minusBtn.style.border = 'none';
        minusBtn.style.width = '28px';
        minusBtn.style.height = '28px';
        minusBtn.style.fontSize = '18px';
        minusBtn.style.cursor = 'pointer';
        minusBtn.style.borderRadius = '3px';
        minusBtn.onclick = function() { changeQuantity(i, -1); };
        qtyDiv.appendChild(minusBtn);
        // Qty input
        const qtyInput = document.createElement('input');
        qtyInput.type = 'text';
        qtyInput.value = quantity;
        qtyInput.readOnly = true;
        qtyInput.style.width = '40px';
        qtyInput.style.textAlign = 'center';
        qtyInput.style.border = '1px solid #ccc';
        qtyInput.style.height = '28px';
        qtyInput.style.fontSize = '14px';
        qtyInput.style.margin = '0 4px';
        qtyInput.style.background = '#f9f9f9';
        qtyInput.style.borderRadius = '3px';
        qtyDiv.appendChild(qtyInput);
        // Plus button
        const plusBtn = document.createElement('button');
        plusBtn.textContent = '+';
        plusBtn.style.backgroundColor = '#3d0c4e';
        plusBtn.style.color = 'white';
        plusBtn.style.border = 'none';
        plusBtn.style.width = '28px';
        plusBtn.style.height = '28px';
        plusBtn.style.fontSize = '18px';
        plusBtn.style.cursor = 'pointer';
        plusBtn.style.borderRadius = '3px';
        plusBtn.onclick = function() { changeQuantity(i, 1); };
        qtyDiv.appendChild(plusBtn);
        detailsDiv.appendChild(qtyDiv);
        // Subtotal right
        const priceDiv = document.createElement('div');
        priceDiv.textContent = formatCurrencyCR(totalItem);
        priceDiv.style.fontWeight = 'bold';
        priceDiv.style.fontSize = '16px';
        priceDiv.style.color = '#3d0c4e';
        priceDiv.style.marginLeft = '10px';
        priceDiv.style.whiteSpace = 'nowrap';
        // Remove button
        const removeDiv = document.createElement('div');
        removeDiv.title = 'Eliminar';
        removeDiv.textContent = '🗑️';
        removeDiv.style.color = 'red';
        removeDiv.style.cursor = 'pointer';
        removeDiv.style.fontSize = '18px';
        removeDiv.style.marginLeft = '12px';
        removeDiv.onclick = function() { removeFromCart(i); };
        // Layout: [img][details][price][remove]
        li.appendChild(imgDiv);
        li.appendChild(detailsDiv);
        li.appendChild(priceDiv);
        li.appendChild(removeDiv);
        cartList.appendChild(li);
      });
      const iva = subtotal * 0.13;
      const total = subtotal + iva;
      document.getElementById("subtotal").textContent = formatCurrencyCR(subtotal);
      document.getElementById("iva").textContent = formatCurrencyCR(iva);
      document.getElementById("total").textContent = formatCurrencyCR(total);
      document.getElementById("cart-count").textContent = cart.reduce((acc, item) => acc + (parseInt(item.qty) || 0), 0);
      // Update cart icon total in header if needed (optional)
    }

    function removeFromCart(index) {
      if (index < 0 || index >= cart.length) return;
      cart.splice(index, 1);
      saveCart();
      renderCart();
      updateCartCount();
    }

    function changeQuantity(index, delta) {
      if (index < 0 || index >= cart.length) return;
      let newQty = cart[index].qty + delta;
      if (newQty < 1) newQty = 1;
      cart[index].qty = newQty;
      saveCart();
      renderCart();
      updateCartCount();
    }

    function attachEvents() {
      document.querySelectorAll('.add-to-cart').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const card = e.target.closest('.product-card');
          const name = card.querySelector('h3').textContent;
          // Extract SKU safely and robustly
          const sku = card.querySelector('p').textContent.match(/SKU:\s*(.+)/)?.[1]?.trim() || '';
          const priceText = card.querySelector('.price').textContent;
          const price = parseFloat(priceText.replace(/[^\d.]/g, ''));
          const qty = parseInt(card.querySelector('input').value);

          if (isNaN(price) || isNaN(qty)) return;

          // Check if product already in cart
          const index = cart.findIndex(item => item.sku === sku);
          if(index !== -1) {
            cart[index].qty = (parseInt(cart[index].qty) || 0) + qty;
          } else {
            cart.push({ name, sku, price, qty });
          }
          saveCart();
          renderCart();
          updateCartCount();
          toggleCart(true);
        });
      });

      document.querySelectorAll('.product-card').forEach(card => {
        const minus = card.querySelector('.minus');
        const plus = card.querySelector('.plus');
        const input = card.querySelector('input');

        minus.addEventListener('click', () => {
          let v = parseInt(input.value);
          if (v > 1) input.value = v - 1;
        });
        plus.addEventListener('click', () => {
          let v = parseInt(input.value);
          input.value = v + 1;
        });
      });
    }

    // On load
    window.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem('logged')) {
        renderCart();
        updateCartCount();
      }
      updateStoreDisplay();
    });

    // Process purchase button click
    document.addEventListener('DOMContentLoaded', () => {
      const processBtn = document.getElementById('process-cart');
      processBtn.addEventListener('click', () => {
        if(cart.length === 0) {
          alert("El carrito está vacío.");
          return;
        }
        alert("Gracias por su compra. Procesando...");
        cart = [];
        saveCart();
        renderCart();
        updateCartCount();
        toggleCart(false);
      });
    });
  </script>

  <div id="cart-sidebar" style="flex-direction: column;">
    <h3>Carrito</h3>
    <ul id="cart-items" style="padding: 0; margin: 0;"></ul>
    <div class="cart-totals">
      <div><span>Subtotal:</span><span id="subtotal">₡0</span></div>
      <div><span>IVA (13%):</span><span id="iva">₡0</span></div>
      <div><strong>Total:</strong><strong id="total">₡0</strong></div>
    </div>
    <!-- Datos del cliente para la orden de compra -->
    <div id="order-client-fields" style="margin-bottom: 10px; margin-top: 10px;">
      <input type="text" id="clienteNombre" placeholder="Nombre cliente" style="width: 100%; margin-bottom: 5px; padding: 7px; border-radius:4px; border:1px solid #ccc;">
      <input type="text" id="clienteSociedad" placeholder="Sociedad cliente" style="width: 100%; margin-bottom: 5px; padding: 7px; border-radius:4px; border:1px solid #ccc;">
      <input type="email" id="clienteCorreo" placeholder="Correo cliente" style="width: 100%; margin-bottom: 5px; padding: 7px; border-radius:4px; border:1px solid #ccc;">
      <input type="text" id="clienteCelular" placeholder="Celular cliente" style="width: 100%; margin-bottom: 5px; padding: 7px; border-radius:4px; border:1px solid #ccc;">
      <label for="deliveryDate" style="display:block; margin-top:8px;">Fecha de entrega:</label>
      <input type="date" id="deliveryDate" required style="width: 100%; margin-bottom: 5px; padding: 7px; border-radius:4px; border:1px solid #ccc;">
    </div>
    <div class="cart-footer" style="justify-content: flex-end;">
      <button id="close-cart" onclick="toggleCart(false)">Cerrar</button>
      <button id="process-cart" style="background: #d32f2f; color: #fff; font-weight: bold; margin-left: 10px; min-width: 160px;">Procesar compra</button>
      <button id="procesar-orden-btn" style="background: #3d0c4e; color: #fff; font-weight: bold; margin-left: 10px; min-width: 160px;">Generar OC PDF</button>
    </div>
  </div>
  <!-- jsPDF library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Botón para generar PDF de Orden de Compra
    document.addEventListener('DOMContentLoaded', function() {
      const btn = document.getElementById("procesar-orden-btn");
      if (!btn) return;
      btn.addEventListener("click", function() {
        // Usar el mismo array cart que maneja el carrito
        const carrito = typeof cart !== "undefined" ? cart : [];
        if (!carrito || carrito.length === 0) {
          alert("El carrito está vacío.");
          return;
        }
        // Validar campos de cliente
        const nombre = document.getElementById("clienteNombre").value.trim();
        const sociedad = document.getElementById("clienteSociedad").value.trim();
        const correo = document.getElementById("clienteCorreo").value.trim();
        const celular = document.getElementById("clienteCelular").value.trim();
        const deliveryDate = document.getElementById("deliveryDate").value;
        if (!nombre || !sociedad || !correo || !celular) {
          alert("Por favor complete todos los datos del cliente.");
          return;
        }
        if (!deliveryDate) {
          alert("Por favor seleccione una fecha de entrega antes de continuar.");
          return;
        }
        // jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        // Consecutivo OC-WEB ###
        let orderNumber = localStorage.getItem("orderNumber") || 1;
        const orderCode = `OC-WEB ${String(orderNumber).padStart(3, '0')}`;
        localStorage.setItem("orderNumber", Number(orderNumber) + 1);
        // Logo Oakberry en base64 (debe reemplazarse con el real si se desea mejor calidad)
        const logoBase64 = "iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAA..."; // Reemplazar con base64 real si se desea
        try {
          doc.addImage(logoBase64, "PNG", 10, 10, 40, 20);
        } catch(e) {
          // Si hay error, omitir logo
        }
        // Datos fijos de empresa
        doc.setFontSize(12);
        doc.text(`ACAI OAK RESTAURANTES`, 150, 15, { align: "right" });
        doc.text(`CELULAR: 6213-8356`, 150, 22, { align: "right" });
        doc.text(`ESCAZU, GUACHIPELIN`, 150, 29, { align: "right" });
        doc.setFontSize(14);
        doc.text(`ORDEN DE COMPRA`, 105, 40, { align: "center" });
        doc.setFontSize(11);
        doc.text(`Consecutivo: ${orderCode}`, 105, 48, { align: "center" });
        // Cliente y datos generales
        doc.setFontSize(11);
        let currentY = 60;
        doc.text(`Cliente: ${nombre}`, 10, currentY);
        currentY += 7;
        doc.text(`Sociedad: ${sociedad}`, 10, currentY);
        currentY += 7;
        doc.text(`Correo: ${correo}`, 10, currentY);
        currentY += 7;
        doc.text(`Celular: ${celular}`, 10, currentY);
        currentY += 7;
        doc.text(`Fecha de entrega: ${deliveryDate}`, 10, currentY);
        currentY += 10;
        // Tabla productos
        let y = currentY + 10;
        let subtotal = 0;
        doc.setFontSize(11);
        doc.text("Producto", 10, y);
        doc.text("Cant", 100, y);
        doc.text("Precio", 120, y);
        doc.text("Subtotal", 160, y);
        y += 7;
        carrito.forEach(item => {
          // item: { name, sku, price, qty }
          const sub = (parseFloat(item.price) || 0) * (parseInt(item.qty) || 0);
          subtotal += sub;
          doc.text(item.name ? String(item.name) : "", 10, y);
          doc.text(String(item.qty), 100, y);
          doc.text(`₡${Number(item.price).toFixed(2)}`, 120, y);
          doc.text(`₡${sub.toFixed(2)}`, 160, y);
          y += 7;
          // Salto si pasa de la hoja
          if (y > 260) {
            doc.addPage();
            y = 20;
          }
        });
        const iva = subtotal * 0.13;
        const total = subtotal + iva;
        y += 10;
        doc.text(`Subtotal: ₡${subtotal.toFixed(2)}`, 140, y);
        y += 7;
        doc.text(`IVA (13%): ₡${iva.toFixed(2)}`, 140, y);
        y += 7;
        doc.text(`Total: ₡${total.toFixed(2)}`, 140, y);
        doc.save(`${orderCode}.pdf`);
        // Mostrar el código en pantalla (puedes mostrarlo en algún lado si gustas)
        // Por ejemplo, alert:
        alert(`Se generó la orden: ${orderCode}`);
      });
    });
  </script>
  <script>
    const storeAddresses = {
      "City Mall": "Centro Comercial City Mall Alajuela, Nivel 2",
      "Avenida Escazú": "Avenida Escazú, Local 102 Edificio 202",
      "Guachipelin": "Centro Comercial calle real en Guachipelin de escazu, local 2",
      "Oak Truck": "Centro comercial aleste, curridabat",
      "Santa Ana Town Center": "Plaza Town Center, Calle Margarita Norte, Ave 3., Santa Ana"
    };

    let selectedStore = localStorage.getItem("store") || "Guachipelin";
    let cartItems = typeof cart !== 'undefined' ? cart : [];

    function handleStoreChange(storeName) {
      // Confirm if cart has items
      if (cart && cart.length > 0) {
        if (confirm("Cambiar de tienda borrará el carrito de compras. ¿Desea continuar?")) {
          // limpiar carrito y cambiar dirección
          cart = [];
          localStorage.removeItem('cart');
          renderCart();
          updateCartCount();
        } else {
          // Reset dropdown to previous value
          document.getElementById("storeSelector").value = selectedStore;
          return;
        }
      }
      selectedStore = storeName;
      localStorage.setItem("store", storeName);
      // Update the dynamic address below the dropdown
      document.getElementById("selected-store-address-value").innerText = storeAddresses[storeName] || '';
    }

    // On load, set dropdown and address, and setup clear cart button
    window.addEventListener("DOMContentLoaded", function() {
      // Set dropdown value and address
      document.getElementById("storeSelector").value = selectedStore;
      document.getElementById("selected-store-address-value").innerText = storeAddresses[selectedStore] || '';
      // Limpiar carrito
      const clearBtn = document.getElementById("clearCartBtn");
      if (clearBtn) {
        clearBtn.addEventListener("click", function() {
          if (cart && cart.length > 0) {
            if (confirm("¿Está seguro de que desea limpiar el carrito de compras?")) {
              cart = [];
              localStorage.removeItem('cart');
              renderCart();
              updateCartCount();
            }
          }
        });
      }
    });
  </script>
</body>
</html>
  <script>
    // Show fallback emoji if FontAwesome is not loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Check if FontAwesome loaded by looking for .fa-store
      const faStore = document.querySelector('.fa-store');
      const fallback = document.getElementById('store-emoji-fallback');
      if (faStore && window.getComputedStyle(faStore).display === "inline-block" && faStore.offsetWidth > 0) {
        fallback.style.display = "none";
      } else {
        faStore.style.display = "none";
        fallback.style.display = "inline-block";
      }
    });
  </script>
